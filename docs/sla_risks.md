# SLA & Risks

Документ фиксирует целевые показатели качества (SLI/SLO/SLA), error budget policy и реестр ключевых рисков с метриками раннего предупреждения.
Фокус: подготовка к предсказуемой эксплуатации (MVP → Scale) и будущей упаковке под B2B.

---

## Термины

- **SLI** (Service Level Indicator) — измеряемая метрика качества (например, доля успешных запросов, доля быстрых ответов).
- **SLO** (Service Level Objective) — целевое значение SLI за окно (например, 99.9% успешных запросов за 30 дней).
- **SLA** — договорная гарантия для клиента; строится поверх SLO и обычно включает ответственность/компенсации.

---

## SLO (draft) — измеримые цели

> Принцип: сначала формализуем SLO и мониторинг, затем (при необходимости) выводим SLA для B2B как “обёртку” поверх фактических SLO.

| Область | SLI | SLO (цель) | Окно | Алёртинг (минимум) | Owner |
|---|---|---:|---:|---|---|
| Доступность API/Web | Доля успешных запросов (2xx/3xx) | ≥ 99.9% | 30 дней | error rate + uptime; burn-rate алёрты | INFRA |
| Latency API (каталоги/справочники) | Доля запросов ≤ 200ms | ≥ 95% | 30 дней | p95/p99 + burn-rate | BACKEND |
| Качество рекомендаций ML | Accuracy на эталонном наборе + post-release мониторинг | ≥ 90% | 7/30 дней | дрейф качества, рост “жалоб” | ML |
| Доверие к агенту | Доля релизов агента с валидной подписью | 100% | релиз | release-gate в CI | AGENT |
| Полнота результатов | Доля “неполных” тестов | < 5% | 30 дней | рост incomplete_tests% | AGENT |

---

## Error budget policy (как управляем риском деградации)

### Бюджеты (пример для 30 дней)
- **Uptime 99.9%** → допускаем до **0.1%** недоступности (≈ 43.2 минут/30 дней).
- **Latency SLO (≥95% ≤200ms)** → допускаем до **5%** “медленных” запросов в окне (по определению SLO).

### Правила реакции (управленческий контур)
- **Burn > 50% бюджета в первые 50% окна** (например, на 15-й день “съели” >50% бюджета):
    - Freeze на не-критические релизы (feature freeze).
    - Приоритизация reliability backlog (инфра, кеши, деградационные режимы, оптимизация запросов).
- **Burn-rate spike** (резкий рост потребления бюджета, например, за часы):
    - инцидентный режим: triage → mitigation → postmortem.
    - временные лимиты/деградация функциональности допустимы, если сохраняют core-путь пользователя.
- **Если бюджет исчерпан**:
    - релизы только “reliability/security fixes”.
    - обязательный RCA и корректировка SLO/архитектуры/лимитов.

---

## Release gates (минимальный набор под будущий B2B)

- **AGENT:** запрет публикации неподписанного релиза (CI gate).
- **BACKEND:** smoke + нагрузочный sanity (хотя бы короткий), лимиты и таймауты.
- **INFRA:** canary/rolling, health-check, rollback playbook.
- **ML:** версионирование моделей, возможность rollback, контроль дрейфа.

---

## Risk Register (B2B-ready)

Статусы: `Open` / `Mitigating` / `Monitoring` / `Accepted`.

| ID | Категория | Риск | Вероятность / Влияние | Метрика тревоги | Сценарий влияния | Owner | Status | KPI / Меры снижения | Runbook | Dashboard |
|---|---|---|---|---|---|---|---|---|---|---|
| R-01 | SLA / B2B | Совместимость сенсоров и железа | Высокая / Среднее | `% incomplete_tests` | Неполные результаты → падение доверия | AGENT | Open | Матрица поддерживаемых CPU/GPU/драйверов; capability-handshake; fallback. KPI: `<5%` | TBD: runbooks/incomplete_tests.md | TBD |
| R-02 | SLA / B2B | Подпись кода и SmartScreen | Средняя / Высокое | `unsigned_release_count` | Блокировка запуска → срыв тестов | AGENT | Mitigating | Официальная подпись; CI release-gate; мониторинг репутации. KPI: `100% signed` | TBD: runbooks/agent_signing.md | TBD |
| R-03 | Технические | Сбои в облачной инфраструктуре | Средняя / Высокое | uptime / error rate | Простой, потеря realtime-сессий | INFRA | Open | Репликация, health-check, резервирование, SLO-monitoring. KPI: `>99.9%` | TBD: runbooks/infra_outage.md | TBD |
| R-04 | Технические | Ошибки ML-моделей | Средняя / Среднее | `% wrong_preds` / drift | Неверные рекомендации → падение доверия | ML | Open | Валидация, A/B, rollback модели. KPI: `>90%` | TBD: runbooks/ml_quality.md | TBD |
| R-05 | Технические | Перегрузка / медленная обработка | Средняя / Среднее | p95 latency / queue depth | Плохой UX → отток | BACKEND | Open | Кеш, rate limits, очереди/буферизация, autoscaling. KPI: Quick `<10s`, Stress `<30m`, API p95 `<200ms` | TBD: runbooks/api_latency.md | TBD |
| R-06 | Безопасность | Утечка персональных данных | Низкая / Высокое | incidents | GDPR/штрафы/потеря доверия | SECURITY | Open | Шифрование, минимизация данных, аудит, ACL. KPI: `0` | TBD: runbooks/security_incident.md | TBD |
| R-07 | Безопасность | Supply-chain / malware в агенте | Низкая / Высокое | AV flags / complaints | Репутационный удар, удаление агента | SECURITY | Open | SBOM, pin deps, sandbox, подпись, воспроизводимые сборки (по возможности). KPI: `0` | TBD: runbooks/supply_chain.md | TBD |
| R-08 | Операционные | Отказ от подписки | Средняя / Среднее | churn | Потеря LTV | PRODUCT | Monitoring | Персонализация, ценностные триггеры, onboarding. KPI: `<5%/мес` | TBD: runbooks/churn_spike.md | TBD |
| R-09 | Бизнес | Конкуренция / падение спроса | Средняя / Среднее | new_users trend | Снижение выручки | PRODUCT | Monitoring | Дифференциация, B2B-интеграции, рост органики. KPI: `+10%/квартал` | TBD | TBD |
| R-10 | Юридические | Нарушение лицензий ПО | Низкая / Среднее | claims | Штрафы/остановка | LEGAL | Open | License scanning (CI), реестр лицензий. KPI: `0` | TBD: runbooks/license_compliance.md | TBD |
| R-11 | Технические | Abuse публичного API (анонимный подбор) | Средняя / Среднее | rate-limit hits / WAF | Скрейпинг/DoS → деградация | BACKEND | Open | Rate limit, кеш справочников, pagination, WAF/бот-защита, API keys для партнёров | TBD: runbooks/api_abuse.md | TBD |

---

## Runbook template (шаблон)

Каждый runbook должен содержать:
1) Trigger/симптомы (какие метрики/алёрты)
2) Быстрая диагностика (проверки 3–5 минут)
3) Mitigation (самые дешёвые и быстрые действия)
4) Escalation (кого будим/когда)
5) Rollback/Recovery (как вернуть сервис)
6) Postmortem checklist (что обновить в системе после инцидента)

---

## Ритм пересмотра рисков

- **Еженедельно:** триаж алёртов + проверка “метрик тревоги”.
- **Ежемесячно:** ревизия Risk Register (вероятность/влияние/статусы), корректировка SLO и мер снижения.
- **После инцидентов:** postmortem + обязательное обновление соответствующей строки (чтобы меры были “живыми”).

---

## Дорожная карта к B2B SLA (будущее)

Когда появятся первые B2B-пилоты:
- ввести **tiered SLA** (например, 99.9% → 99.95% для Enterprise),
- определить **support hours / response time** (8x5 / 24x7),
- формализовать **service credits** как функцию нарушений SLA,
- зафиксировать “исключения” (плановые окна, форс-мажор, зависимость от третьих сторон).
